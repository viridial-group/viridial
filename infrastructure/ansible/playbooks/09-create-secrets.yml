---
# Playbook: Création des secrets Kubernetes
# Description: Crée les secrets Kubernetes depuis les fichiers .env

- name: Créer secrets Kubernetes
  hosts: control_plane
  become: true
  vars:
    secrets_dir: "{{ playbook_dir }}/../../secrets"

  tasks:
    - name: Vérifier fichier .env
      stat:
        path: "{{ secrets_dir }}/.env"
      register: env_file

    - name: Créer namespace staging si nécessaire
      k8s:
        name: viridial-staging
        api_version: v1
        kind: Namespace
        state: present

    - name: Créer namespace production si nécessaire
      k8s:
        name: viridial-production
        api_version: v1
        kind: Namespace
        state: present

    - name: Lire fichier .env
      slurp:
        src: "{{ secrets_dir }}/.env"
      register: env_content
      when: env_file.stat.exists

    - name: Parser variables .env
      set_fact:
        env_vars: "{{ env_content.content | b64decode | regex_findall('^([A-Z_]+)=(.*)$', multiline=True) }}"
      when: env_file.stat.exists

    - name: Créer secret SMTP pour staging
      k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: smtp-config
            namespace: viridial-staging
          type: Opaque
          stringData:
            FROM_NAME: "support@viridial.com"
            SMTP_HOST: "smtp.hostinger.com"
            SMTP_PORT: "465"
            SMTP_SECURE: "true"
            SMTP_USER: "support@viridial.com"
            SMTP_PASS: "S@upport!19823"
            EMAIL_FROM: "support@viridial.com"

    - name: Créer secret SMTP pour production
      k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: smtp-config
            namespace: viridial-production
          type: Opaque
          stringData:
            FROM_NAME: "support@viridial.com"
            SMTP_HOST: "smtp.hostinger.com"
            SMTP_PORT: "465"
            SMTP_SECURE: "true"
            SMTP_USER: "support@viridial.com"
            SMTP_PASS: "S@upport!19823"
            EMAIL_FROM: "support@viridial.com"

    - name: Vérifier secrets créés
      shell: kubectl get secrets -n viridial-staging | grep smtp
      register: secrets_check
      changed_when: false

    - name: Afficher secrets
      debug:
        msg: "{{ secrets_check.stdout }}"

