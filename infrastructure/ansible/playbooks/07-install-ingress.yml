---
# Playbook: Installation de Nginx Ingress Controller
# Description: Installe Nginx Ingress avec cert-manager pour TLS automatique

- name: Installer Nginx Ingress et Cert-manager
  hosts: control_plane
  become: true

  tasks:
    - name: Vérifier Nginx Ingress
      shell: kubectl get namespace ingress-nginx 2>/dev/null || echo "not-found"
      register: ingress_check
      changed_when: false

    - name: Installer Nginx Ingress Controller
      shell: |
        kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.9.4/deploy/static/provider/cloud/deploy.yaml
      when: "'not-found' in ingress_check.stdout"

    - name: Attendre que Ingress Controller soit prêt
      shell: kubectl wait --namespace ingress-nginx --for=condition=ready pod --selector=app.kubernetes.io/component=controller --timeout=300s
      when: "'not-found' in ingress_check.stdout"
      ignore_errors: true

    - name: Vérifier Cert-manager
      shell: kubectl get namespace cert-manager 2>/dev/null || echo "not-found"
      register: certmanager_check
      changed_when: false

    - name: Installer Cert-manager CRDs
      shell: |
        kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.3/cert-manager.yaml
      when: "'not-found' in certmanager_check.stdout"

    - name: Attendre que Cert-manager soit prêt
      shell: kubectl wait --namespace cert-manager --for=condition=ready pod --selector=app.kubernetes.io/instance=cert-manager --timeout=300s
      when: "'not-found' in certmanager_check.stdout"
      ignore_errors: true

    - name: Créer ClusterIssuer Let's Encrypt (staging)
      k8s:
        state: present
        definition:
          apiVersion: cert-manager.io/v1
          kind: ClusterIssuer
          metadata:
            name: letsencrypt-staging
          spec:
            acme:
              server: https://acme-staging-v02.api.letsencrypt.org/directory
              email: "{{ letsencrypt_email }}"
              privateKeySecretRef:
                name: letsencrypt-staging
              solvers:
              - http01:
                  ingress:
                    class: nginx

    - name: Créer ClusterIssuer Let's Encrypt (production)
      k8s:
        state: present
        definition:
          apiVersion: cert-manager.io/v1
          kind: ClusterIssuer
          metadata:
            name: letsencrypt-prod
          spec:
            acme:
              server: https://acme-v02.api.letsencrypt.org/directory
              email: "{{ letsencrypt_email }}"
              privateKeySecretRef:
                name: letsencrypt-prod
              solvers:
              - http01:
                  ingress:
                    class: nginx

    - name: Vérifier installation
      shell: kubectl get pods -n ingress-nginx && kubectl get pods -n cert-manager
      register: ingress_status
      changed_when: false

    - name: Afficher status Ingress et Cert-manager
      debug:
        msg: "{{ ingress_status.stdout }}"

