---
# Playbook: Préparation des VPS pour Kubernetes
# Description: Configure les prérequis système (Docker, swap, firewall, etc.)

- name: Préparation VPS pour Kubernetes
  hosts: k8s_cluster
  become: true
  vars:
    docker_version: "24.0"
    k8s_version: "1.29"

  tasks:
    - name: Mettre à jour le système
      apt:
        update_cache: yes
        upgrade: dist
        cache_valid_time: 3600

    - name: Installer dépendances système
      apt:
        name:
          - curl
          - wget
          - git
          - vim
          - ufw
          - apt-transport-https
          - ca-certificates
          - gnupg
          - lsb-release
        state: present

    - name: Désactiver swap
      shell: |
        swapoff -a
        sed -i '/ swap / s/^/#/' /etc/fstab
      changed_when: false

    - name: Configurer modules kernel pour Kubernetes
      copy:
        content: |
          overlay
          br_netfilter
        dest: /etc/modules-load.d/k8s.conf
        mode: '0644'

    - name: Charger modules kernel
      modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - overlay
        - br_netfilter

    - name: Configurer sysctl pour Kubernetes
      copy:
        content: |
          net.bridge.bridge-nf-call-iptables  = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward                 = 1
        dest: /etc/sysctl.d/k8s.conf
        mode: '0644'

    - name: Appliquer sysctl
      command: sysctl --system

    - name: Configurer firewall UFW
      ufw:
        rule: allow
        port: "{{ item }}"
        proto: tcp
      loop:
        - "22"      # SSH
        - "6443"    # Kubernetes API
        - "10250"   # Kubelet
        - "2379"    # etcd
        - "2380"    # etcd
        - "30000:32767"  # NodePort services

    - name: Activer firewall UFW
      ufw:
        state: enabled
        policy: deny

    - name: Installer Docker
      shell: |
        curl -fsSL https://get.docker.com -o get-docker.sh
        sh get-docker.sh
        rm get-docker.sh
      args:
        creates: /usr/bin/docker

    - name: Configurer Docker daemon pour Kubernetes
      copy:
        content: |
          {
            "exec-opts": ["native.cgroupdriver=systemd"],
            "log-driver": "json-file",
            "log-opts": {
              "max-size": "100m"
            },
            "storage-driver": "overlay2"
          }
        dest: /etc/docker/daemon.json
        mode: '0644'

    - name: Redémarrer Docker
      systemd:
        name: docker
        state: restarted
        enabled: true

    - name: Ajouter utilisateur au groupe docker
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: true

    - name: Installer outils Kubernetes (kubeadm, kubelet, kubectl)
      apt:
        name:
          - kubelet={{ k8s_version }}-00
          - kubeadm={{ k8s_version }}-00
          - kubectl={{ k8s_version }}-00
        state: present
        update_cache: yes

    - name: Empêcher mises à jour automatiques de kubelet/kubeadm/kubectl
      apt:
        name:
          - kubelet={{ k8s_version }}-00
          - kubeadm={{ k8s_version }}-00
          - kubectl={{ k8s_version }}-00
        state: present
        update_cache: no
      when: ansible_os_family == "Debian"

    - name: Activer kubelet
      systemd:
        name: kubelet
        enabled: true
        daemon_reload: true

    - name: Vérifier prérequis
      command: kubeadm version
      register: kubeadm_version
      changed_when: false

    - name: Afficher version kubeadm
      debug:
        msg: "Kubeadm version: {{ kubeadm_version.stdout }}"

