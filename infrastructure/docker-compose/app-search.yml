version: '3.8'

services:
  search-service:
    build:
      context: ../../services/search-service
      dockerfile: Dockerfile
    image: viridial/search-service:latest
    container_name: viridial-search-service
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3003
      # Meilisearch
      MEILISEARCH_URL: ${MEILISEARCH_URL:-http://meilisearch:7700}
      MEILI_MASTER_KEY: ${MEILI_MASTER_KEY}
      # Frontend URL for CORS
      FRONTEND_URL: ${FRONTEND_URL:-https://viridial.com}
    ports:
      - "3003:3003"
    networks:
      - viridial-network
    depends_on:
      - meilisearch
    # Health check
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3003/search/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s

  # Meilisearch (if not already running in docker-compose.yml)
  meilisearch:
    image: getmeili/meilisearch:v1.5
    container_name: viridial-meilisearch
    restart: unless-stopped
    environment:
      MEILI_MASTER_KEY: ${MEILI_MASTER_KEY}
      # Development mode (disable authentication for local dev)
      # MEILI_ENV: development
    volumes:
      - meilisearch_data:/meili_data
    ports:
      - "${MEILISEARCH_PORT:-7700}:7700"
    networks:
      - viridial-network
    # Health check
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:7700/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s

volumes:
  meilisearch_data:

networks:
  viridial-network:
    external: true

# Note:
# - Search Service depends on Meilisearch
# - Meilisearch index will be initialized on first start (see MeilisearchService.onModuleInit)
# - Property Service should call Search Service to index properties when published

